<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do List - Agenda Web</title>
    <link rel="stylesheet" href="/style/todo.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header class="header">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-address-book"></i>
                <span>Agenda Web</span>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <div>
                    <div id="userEmail">usuario@ejemplo.com</div>
                    <a href="../index.html" style="color: white; font-size: 12px;">Cerrar sesión</a>
                </div>
            </div>
        </div>
    </header>
    
    <nav class="nav-menu">
        <ul class="nav-links">
            <li><a href="contactos.html"><i class="fas fa-users"></i> Contactos</a></li>
            <li><a href="favoritos.html"><i class="fas fa-star"></i> Favoritos</a></li>
            <li><a href="todo.html" class="active"><i class="fas fa-tasks"></i> To-Do List</a></li>
            <li><a href="perfil.html"><i class="fas fa-user"></i> Perfil</a></li>
        </ul>
    </nav>
    
    <main class="main-container">
        <div class="page-title">
            <h1><i class="fas fa-tasks"></i> Lista de Tareas</h1>
        </div>
        
        <div class="todo-container">
            <div class="todo-form-container">
                <h2><i class="fas fa-plus-circle"></i> Nueva Tarea</h2>
                <form id="todoForm">
                    <div class="form-group">
                        <label for="taskTitle">Título de la tarea <span style="color: red;">*</span></label>
                        <input type="text" id="taskTitle" required placeholder="Ej: Llamar al médico">
                    </div>
                    
                    <div class="form-group">
                        <label for="taskDescription">Descripción</label>
                        <textarea id="taskDescription" rows="3" placeholder="Detalles de la tarea"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskPriority">Prioridad</label>
                        <select id="taskPriority">
                            <option value="high">Alta</option>
                            <option value="medium" selected>Media</option>
                            <option value="low">Baja</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn-primary" style="width: 100%;">
                        <i class="fas fa-plus"></i> Agregar Tarea
                    </button>
                </form>
                
                <div style="margin-top: 30px; padding: 15px; background-color: #f8f9ff; border-radius: 8px;">
                    <h3><i class="fas fa-info-circle"></i> Instrucciones</h3>
                    <ul style="padding-left: 20px; margin-top: 10px; font-size: 14px;">
                        <li>Haz clic en el checkbox para marcar como completada</li>
                        <li>Usa los botones de editar y eliminar para gestionar tareas</li>
                        <li>Las tareas se ordenan por prioridad (Alta > Media > Baja)</li>
                    </ul>
                </div>
            </div>
            
            <div class="todo-list-container">
                <h2><i class="fas fa-list-check"></i> Mis Tareas</h2>
                <div class="todo-list" id="todoList">
                    <div class="no-tasks" id="noTasksMessage">
                        <i class="fas fa-clipboard-list" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <p>No hay tareas pendientes. ¡Agrega tu primera tarea!</p>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <div>
                        <span id="taskCount">Total: 0 tareas (0 completadas)</span>
                    </div>
                    <div>
                        <button class="btn-secondary" id="clearCompletedBtn">
                            <i class="fas fa-trash"></i> Limpiar Completadas
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script>
        
        let todoApp;
        
        
        class TodoList {
            constructor() {
                this.tasks = this.loadTasks();
                console.log("TodoList inicializado con", this.tasks.length, "tareas");
                this.render();
            }
            
            loadTasks() {
                try {
                    const savedTasks = localStorage.getItem('todoTasks');
                    if (savedTasks) {
                        return JSON.parse(savedTasks);
                    }
                } catch (error) {
                    console.error("Error cargando tareas:", error);
                }
                
                
                return [
                    { 
                        id: Date.now() - 3, 
                        title: "Llamar al médico", 
                        description: "Pedir cita para revisión anual", 
                        priority: "high", 
                        completed: false 
                    },
                    { 
                        id: Date.now() - 2, 
                        title: "Comprar víveres", 
                        description: "Leche, huevos, pan y frutas", 
                        priority: "medium", 
                        completed: false 
                    },
                    { 
                        id: Date.now() - 1, 
                        title: "Enviar reporte mensual", 
                        description: "Reporte de ventas del mes anterior", 
                        priority: "low", 
                        completed: true 
                    }
                ];
            }
            
            saveTasks() {
                try {
                    localStorage.setItem('todoTasks', JSON.stringify(this.tasks));
                    console.log("Tareas guardadas:", this.tasks);
                } catch (error) {
                    console.error("Error guardando tareas:", error);
                }
            }
            
            addTask(title, description, priority) {
                const newTask = {
                    id: Date.now(), 
                    title: title.trim(),
                    description: description.trim(),
                    priority: priority,
                    completed: false
                };
                
                console.log("Agregando nueva tarea:", newTask);
                this.tasks.push(newTask);
                this.saveTasks();
                this.render();
                return true;
            }
            
            deleteTask(id) {
                console.log("Eliminando tarea con ID:", id);
                const initialLength = this.tasks.length;
                this.tasks = this.tasks.filter(task => task.id !== id);
                
                if (this.tasks.length < initialLength) {
                    console.log("Tarea eliminada exitosamente");
                    this.saveTasks();
                    this.render();
                    return true;
                } else {
                    console.log("No se encontró la tarea para eliminar");
                    return false;
                }
            }
            
            toggleComplete(id) {
                console.log("Cambiando estado de tarea ID:", id);
                let changed = false;
                
                this.tasks = this.tasks.map(task => {
                    if (task.id === id) {
                        changed = true;
                        return { ...task, completed: !task.completed };
                    }
                    return task;
                });
                
                if (changed) {
                    this.saveTasks();
                    this.render();
                }
            }
            
            editTask(id, newTitle, newDescription, newPriority) {
                console.log("Editando tarea ID:", id);
                let changed = false;
                
                this.tasks = this.tasks.map(task => {
                    if (task.id === id) {
                        changed = true;
                        return { 
                            ...task, 
                            title: newTitle.trim(), 
                            description: newDescription.trim(),
                            priority: newPriority
                        };
                    }
                    return task;
                });
                
                if (changed) {
                    this.saveTasks();
                    this.render();
                    return true;
                }
                return false;
            }
            
            clearCompleted() {
                console.log("Limpiando tareas completadas");
                const initialLength = this.tasks.length;
                this.tasks = this.tasks.filter(task => !task.completed);
                
                if (this.tasks.length < initialLength) {
                    this.saveTasks();
                    this.render();
                    return true;
                }
                return false;
            }
            
            render() {
                console.log("Renderizando lista de tareas...");
                const todoList = document.getElementById('todoList');
                const noTasksMessage = document.getElementById('noTasksMessage');
                const taskCount = document.getElementById('taskCount');
                
                
                const sortedTasks = [...this.tasks].sort((a, b) => {
                    if (a.completed && !b.completed) return 1;
                    if (!a.completed && b.completed) return -1;
                    
                    const priorityOrder = { high: 1, medium: 2, low: 3 };
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                });
                
                if (sortedTasks.length === 0) {
                    console.log("No hay tareas para mostrar");
                    noTasksMessage.style.display = 'block';
                    todoList.innerHTML = '';
                    todoList.appendChild(noTasksMessage);
                } else {
                    console.log("Mostrando", sortedTasks.length, "tareas");
                    noTasksMessage.style.display = 'none';
                    
                    let todoHTML = '';
                    
                    sortedTasks.forEach(task => {
                        const priorityClass = `priority-${task.priority}`;
                        const priorityText = task.priority === 'high' ? 'Alta' : 
                                           task.priority === 'medium' ? 'Media' : 'Baja';
                        
                        todoHTML += `
                            <div class="todo-item" data-id="${task.id}">
                                <div class="todo-content">
                                    <input type="checkbox" class="todo-checkbox" ${task.completed ? 'checked' : ''}>
                                    <div>
                                        <div class="todo-text ${task.completed ? 'completed' : ''}">${task.title}</div>
                                        ${task.description ? `<div class="todo-description">${task.description}</div>` : ''}
                                    </div>
                                </div>
                                <div>
                                    <span class="todo-priority ${priorityClass}">${priorityText}</span>
                                    <div class="todo-actions">
                                        <button type="button" class="edit-btn" data-id="${task.id}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="delete-btn" data-id="${task.id}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    todoList.innerHTML = todoHTML;
                    
                   
                    todoList.addEventListener('change', (e) => {
                        if (e.target.classList.contains('todo-checkbox')) {
                            const taskId = parseInt(e.target.closest('.todo-item').dataset.id);
                            console.log("Checkbox cambiado para tarea ID:", taskId);
                            this.toggleComplete(taskId);
                        }
                    });
                    
                    todoList.addEventListener('click', (e) => {
                        
                        if (e.target.closest('.delete-btn') || e.target.classList.contains('fa-trash')) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            const deleteBtn = e.target.closest('.delete-btn');
                            const taskId = parseInt(deleteBtn.dataset.id);
                            
                            if (confirm('¿Estás seguro de que quieres eliminar esta tarea?')) {
                                console.log("Confirmada eliminación de tarea ID:", taskId);
                                this.deleteTask(taskId);
                            }
                        }
                        
                        
                        if (e.target.closest('.edit-btn') || e.target.classList.contains('fa-edit')) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            const editBtn = e.target.closest('.edit-btn');
                            const taskId = parseInt(editBtn.dataset.id);
                            const task = this.tasks.find(t => t.id === taskId);
                            
                            if (!task) {
                                console.error("No se encontró la tarea para editar");
                                return;
                            }
                            
                            console.log("Editando tarea:", task);
                            
                            const newTitle = prompt('Editar título:', task.title);
                            if (newTitle !== null && newTitle.trim() !== '') {
                                const newDescription = prompt('Editar descripción:', task.description || '');
                                const priorityOptions = ['alta', 'media', 'baja', 'high', 'medium', 'low'];
                                const currentPriority = task.priority === 'high' ? 'alta' : 
                                                      task.priority === 'medium' ? 'media' : 'baja';
                                
                                let newPriority = prompt('Editar prioridad (alta/media/baja):', currentPriority);
                                
                                
                                let priorityValue = task.priority;
                                if (newPriority && priorityOptions.includes(newPriority.toLowerCase())) {
                                    const priorityMap = {
                                        'alta': 'high',
                                        'media': 'medium', 
                                        'baja': 'low',
                                        'high': 'high',
                                        'medium': 'medium',
                                        'low': 'low'
                                    };
                                    priorityValue = priorityMap[newPriority.toLowerCase()];
                                }
                                
                                this.editTask(taskId, newTitle.trim(), newDescription || '', priorityValue);
                            }
                        }
                    });
                }
                
                
                const totalTasks = this.tasks.length;
                const completedTasks = this.tasks.filter(task => task.completed).length;
                taskCount.textContent = `Total: ${totalTasks} tareas (${completedTasks} completadas)`;
                console.log("Contador actualizado:", totalTasks, "tareas totales,", completedTasks, "completadas");
            }
        }
        
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log("=== INICIANDO APLICACIÓN TODO LIST ===");
            
           
            const userEmail = localStorage.getItem('userEmail') || 'usuario@ejemplo.com';
            document.getElementById('userEmail').textContent = userEmail;
            
            const userInitial = userEmail.charAt(0).toUpperCase();
            document.getElementById('userAvatar').textContent = userInitial;
            
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (!isLoggedIn || isLoggedIn !== 'true') {
                console.log("Usuario no logueado, redirigiendo...");
                window.location.href = '../index.html';
                return;
            }
            
            
            const logoutLink = document.querySelector('a[href="../index.html"]');
            if (logoutLink) {
                logoutLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('todoTasks');
                    
                    window.location.href = '../index.html';
                });
            }
            
            
            console.log("Creando nueva instancia de TodoList...");
            todoApp = new TodoList();
            
            
            const todoForm = document.getElementById('todoForm');
            if (todoForm) {
                todoForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log("=== PROCESANDO NUEVA TAREA ===");
                    
                    const titleInput = document.getElementById('taskTitle');
                    const descriptionInput = document.getElementById('taskDescription');
                    const prioritySelect = document.getElementById('taskPriority');
                    
                    const title = titleInput.value.trim();
                    const description = descriptionInput.value.trim();
                    const priority = prioritySelect.value;
                    
                    console.log("Datos del formulario:", {title, description, priority});
                    
                    if (title) {
                        console.log("Validación OK, llamando addTask...");
                        const success = todoApp.addTask(title, description, priority);
                        
                        if (success) {
                            console.log("Tarea agregada exitosamente");
                            // Limpiar formulario
                            titleInput.value = '';
                            descriptionInput.value = '';
                            prioritySelect.value = 'medium';
                            
                            
                            titleInput.focus();
                        } else {
                            console.error("Error al agregar tarea");
                        }
                    } else {
                        console.log("Título vacío, mostrando alerta");
                        alert('Por favor ingresa un título para la tarea');
                        titleInput.focus();
                    }
                });
            } else {
                console.error("No se encontró el formulario con id 'todoForm'");
            }
            
            
            const clearBtn = document.getElementById('clearCompletedBtn');
            if (clearBtn) {
                clearBtn.addEventListener('click', function() {
                    console.log("=== LIMPIANDO TAREAS COMPLETADAS ===");
                    if (confirm('¿Estás seguro de que quieres eliminar todas las tareas completadas?')) {
                        const success = todoApp.clearCompleted();
                        if (success) {
                            console.log("Tareas completadas eliminadas exitosamente");
                        } else {
                            console.log("No había tareas completadas para eliminar");
                        }
                    }
                });
            }
            
            console.log("=== APLICACIÓN INICIALIZADA CORRECTAMENTE ===");
            console.log("Puedes abrir la consola (F12) para ver los logs en tiempo real");
        });
    </script>
</body>
</html>